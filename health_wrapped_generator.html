<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Health Wrapped 2025 Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Arial Black', Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 25%, #16213e 50%, #0f3460 100%);
            background-attachment: fixed;
            color: white;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Views */
        .view {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .year {
            font-size: clamp(48px, 12vw, 96px);
            font-weight: 900;
            background: linear-gradient(135deg, #00f5a0 0%, #00d9f5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -2px;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: clamp(20px, 4vw, 36px);
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 3px;
        }

        /* Upload View */
        .upload-area {
            max-width: 600px;
            margin: 60px auto;
            padding: 60px 40px;
            border: 3px dashed rgba(0, 245, 160, 0.3);
            border-radius: 24px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #00f5a0;
            background: rgba(0, 245, 160, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #00f5a0;
        }

        .upload-subtext {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.6);
        }

        input[type="file"] {
            display: none;
        }

        /* Processing View */
        .processing-card {
            max-width: 600px;
            margin: 60px auto;
            padding: 40px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00f5a0, #00d9f5);
            transition: width 0.3s ease;
            width: 0%;
        }

        .stats-text {
            font-size: 18px;
            margin: 10px 0;
            color: rgba(255, 255, 255, 0.8);
        }

        .stats-number {
            font-weight: 900;
            color: #00f5a0;
        }

        /* Button Styles */
        .btn {
            display: inline-block;
            padding: 16px 32px;
            margin: 10px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #00f5a0, #00d9f5);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 245, 160, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-large {
            padding: 24px 48px;
            font-size: 24px;
            margin-top: 20px;
        }

        .button-group {
            text-align: center;
            margin-top: 30px;
        }

        /* Bento Grid Layout */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .bento-grid {
                grid-template-columns: repeat(4, 1fr);
                grid-auto-rows: 180px;
            }
            .bento-item-1 { grid-column: span 2; grid-row: span 2; }
            .bento-item-2 { grid-column: span 2; grid-row: span 1; }
            .bento-item-3 { grid-column: span 2; grid-row: span 1; }
            .bento-item-4 { grid-column: span 1; grid-row: span 2; }
            .bento-item-5 { grid-column: span 1; grid-row: span 2; }
            .bento-item-7 { grid-column: span 2; grid-row: span 1; }
            .bento-item-8 { grid-column: span 1; grid-row: span 2; }
            .bento-item-9 { grid-column: span 1; grid-row: span 2; }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: clamp(20px, 3vw, 40px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 12px 40px rgba(0, 245, 160, 0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #00f5a0, #00d9f5, #a537fd, #ff6b6b, #ffd93d);
            opacity: 0.8;
        }

        .stat-label {
            font-size: clamp(12px, 2vw, 18px);
            font-weight: 600;
            color: rgba(160, 160, 160, 0.9);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .stat-value {
            font-size: clamp(32px, 5vw, 64px);
            font-weight: 900;
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-unit {
            font-size: clamp(14px, 2vw, 20px);
            font-weight: 600;
            color: rgba(0, 245, 160, 0.8);
            line-height: 1.4;
        }

        .highlight-1 { color: #00f5a0; }
        .highlight-2 { color: #00d9f5; }
        .highlight-3 { color: #a537fd; }
        .highlight-4 { color: #ff6b6b; }
        .highlight-5 { color: #ffd93d; }

        .mega-stat {
            text-align: center;
            justify-content: center;
        }

        .mega-stat .stat-value {
            font-size: clamp(48px, 8vw, 96px);
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 50%, #00f5a0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
        }

        .double-stat {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: center;
        }

        .double-stat > div {
            text-align: center;
        }

        /* Background decorations */
        .circle-decoration {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.6;
        }

        .circle-1 {
            width: clamp(200px, 40vw, 500px);
            height: clamp(200px, 40vw, 500px);
            top: -10%;
            right: -10%;
            background: radial-gradient(circle, rgba(0, 245, 160, 0.15) 0%, transparent 70%);
            animation: float 20s ease-in-out infinite;
        }

        .circle-2 {
            width: clamp(250px, 50vw, 600px);
            height: clamp(250px, 50vw, 600px);
            bottom: -15%;
            left: -15%;
            background: radial-gradient(circle, rgba(165, 55, 253, 0.15) 0%, transparent 70%);
            animation: float 25s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-4px);
        }

        /* Charts View */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-title {
            font-size: 24px;
            font-weight: 700;
            color: #00f5a0;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
</head>
<body>
    <div class="circle-decoration circle-1"></div>
    <div class="circle-decoration circle-2"></div>

    <div class="container">
        <!-- Upload View -->
        <div id="uploadView" class="view active">
            <div class="header">
                <div class="year">2025</div>
                <div class="subtitle">HEALTH WRAPPED GENERATOR</div>
            </div>

            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìä</div>
                <div class="upload-text">Drop your export.xml here</div>
                <div class="upload-subtext">or click to browse</div>
                <input type="file" id="fileInput" accept=".xml">
            </div>

            <div style="text-align: center; margin-top: 40px; color: rgba(255,255,255,0.6);">
                <p>‚úì Processes 2025 data only</p>
                <p>‚úì All processing happens locally in your browser</p>
                <p>‚úì Your data never leaves your device</p>
            </div>
        </div>

        <!-- Processing View -->
        <div id="processingView" class="view">
            <div class="header">
                <div class="subtitle">PROCESSING YOUR HEALTH DATA</div>
            </div>

            <div class="processing-card">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <div class="stats-text">
                    Progress: <span class="stats-number" id="progressPercent">0%</span>
                </div>
                <div class="stats-text">
                    Records processed: <span class="stats-number" id="recordsProcessed">0</span>
                </div>
                <div class="stats-text">
                    Records found: <span class="stats-number" id="recordsFound">0</span>
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="resultsView" class="view">
            <div class="header">
                <div class="subtitle">PROCESSING COMPLETE!</div>
            </div>

            <div class="processing-card">
                <div class="stats-text" style="font-size: 24px; text-align: center;">
                    ‚úÖ Successfully processed <span class="stats-number" id="finalRecordCount">0</span> health records from 2025
                </div>

                <div style="margin: 30px 0; text-align: center;">
                    <div class="stats-text" style="margin-bottom: 15px;">For personalized fitness age calculation:</div>
                    <div style="display: flex; gap: 15px; justify-content: center; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label style="color: rgba(255,255,255,0.8); margin-right: 10px;">Your Age:</label>
                            <input type="number" id="userAge" min="18" max="100" placeholder="25"
                                   style="padding: 10px; border-radius: 8px; border: 2px solid rgba(0,245,160,0.3);
                                          background: rgba(255,255,255,0.1); color: white; width: 80px; font-size: 16px;">
                        </div>
                        <div>
                            <label style="color: rgba(255,255,255,0.8); margin-right: 10px;">Gender:</label>
                            <select id="userGender"
                                    style="padding: 10px; border-radius: 8px; border: 2px solid rgba(0,245,160,0.3);
                                           background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px; color: rgba(255,255,255,0.5);">
                        (Optional - used to calculate your fitness age)
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn" id="downloadCsvBtn">üì• Download CSV</button>
                    <br>
                    <button class="btn btn-large" id="showWrappedBtn">‚ú® Show me my 2025 in review</button>
                </div>
            </div>
        </div>

        <!-- Wrapped View -->
        <div id="wrappedView" class="view">
            <button class="back-btn" id="backBtn">‚Üê Back to Results</button>

            <div class="header">
                <div class="year">2025</div>
                <div class="subtitle">YOUR HEALTH WRAPPED</div>
            </div>

            <div class="bento-grid">
                <!-- Hero: Total Steps -->
                <div class="stat-card mega-stat bento-item-1">
                    <div class="stat-label">Total Steps</div>
                    <div class="stat-value" id="wrappedSteps">0</div>
                    <div class="stat-unit">That's incredible!</div>
                </div>

                <!-- Distance -->
                <div class="stat-card bento-item-2">
                    <div class="stat-label">Distance Traveled</div>
                    <div class="stat-value highlight-2"><span id="wrappedMiles">0</span> <span class="stat-unit">miles</span></div>
                    <div class="stat-unit" id="wrappedKm">0 km</div>
                    <div class="stat-unit" id="moonComparison" style="margin-top: 8px; opacity: 0.7; font-size: 14px;"></div>
                </div>

                <!-- Daily Average -->
                <div class="stat-card bento-item-3">
                    <div class="stat-label">Avg Daily Steps</div>
                    <div class="stat-value highlight-5" id="wrappedAvgSteps">0</div>
                    <div class="stat-unit" id="wrappedStepsMessage">Keep moving!</div>
                </div>

                <!-- Flights Climbed -->
                <div class="stat-card bento-item-4">
                    <div class="stat-label">Flights Climbed</div>
                    <div class="stat-value highlight-3" id="wrappedFlights">0</div>
                    <div class="stat-unit">flights</div>
                    <div class="stat-unit" id="burjKhalifaComparison" style="margin-top: 8px; opacity: 0.7; font-size: 14px;"></div>
                </div>

                <!-- Fitness Age -->
                <div class="stat-card bento-item-5" id="fitnessAgeCard" style="display: none;">
                    <div class="stat-label">Fitness Age</div>
                    <div class="stat-value highlight-4" id="wrappedFitnessAge">-</div>
                    <div class="stat-unit" id="fitnessAgeMessage">years old</div>
                </div>

                <!-- Time Standing (always shown) -->
                <div class="stat-card bento-item-9">
                    <div class="stat-label">Time Standing</div>
                    <div class="stat-value highlight-1" id="wrappedStanding">0</div>
                    <div class="stat-unit">Days stood up</div>
                </div>

                <!-- Record Day -->
                <div class="stat-card bento-item-7">
                    <div class="stat-label">Your Best Day</div>
                    <div class="stat-value highlight-3" id="wrappedBestDayDate" style="font-size: clamp(24px, 4vw, 48px);">-</div>
                    <div class="stat-unit" id="wrappedBestDaySteps" style="font-size: clamp(20px, 3vw, 32px); margin-top: 8px;">0 Steps</div>
                </div>

                <!-- Time Asleep -->
                <div class="stat-card bento-item-8">
                    <div class="stat-label">Time Asleep</div>
                    <div class="stat-value highlight-5" id="wrappedAsleep">0</div>
                    <div class="stat-unit">Days asleep</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div style="margin-top: 60px;">
                <div class="header">
                    <div class="subtitle">DATA EXPLORER</div>
                </div>

                <div class="charts-grid">
                    <!-- Steps Over Time -->
                    <div class="chart-card">
                        <div class="chart-title">Daily Steps Over Time</div>
                        <div class="chart-container">
                            <canvas id="stepsChart"></canvas>
                        </div>
                    </div>

                    <!-- Monthly Totals -->
                    <div class="chart-card">
                        <div class="chart-title">Monthly Activity Summary</div>
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>

                    <!-- Activity by Day of Week -->
                    <div class="chart-card">
                        <div class="chart-title">Activity by Day of Week</div>
                        <div class="chart-container">
                            <canvas id="weekdayChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" id="downloadCsvBtn2">üì• Download CSV</button>
            </div>
        </div>
    </div>

    <script>
        // State management
        const state = {
            file: null,
            worker: null,
            csvData: [],
            stats: {
                totalSteps: 0,
                stepsByDay: {},
                totalDistance: 0,
                heartRates: [],
                totalFlights: 0,
                totalStandTime: 0,
                sleepInBed: 0,
                sleepAsleep: 0,
                recordsProcessed: 0,
                recordsFound: 0
            },
            userAge: null,
            userGender: 'male'
        };

        // View management
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        // Process file
        async function handleFile(file) {
            if (!file.name.endsWith('.xml')) {
                alert('Please select an XML file');
                return;
            }

            state.file = file;
            showView('processingView');
            await processFile(file);
        }

        // File processing with chunking
        async function processFile(file) {
            const CHUNK_SIZE = 1024 * 1024; // 1MB chunks
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            let offset = 0;
            let buffer = '';

            state.csvData = [];
            state.stats = {
                totalSteps: 0,
                stepsByDay: {},
                totalDistance: 0,
                heartRates: [],
                totalFlights: 0,
                totalStandTime: 0,
                sleepInBed: 0,
                sleepAsleep: 0,
                recordsProcessed: 0,
                recordsFound: 0
            };

            for (let i = 0; i < totalChunks; i++) {
                const chunk = file.slice(offset, offset + CHUNK_SIZE);
                const text = await chunk.text();
                buffer += text;

                // Process complete lines
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line for next chunk

                for (const line of lines) {
                    processLine(line);
                }

                offset += CHUNK_SIZE;
                const progress = Math.round((offset / file.size) * 100);
                updateProgress(progress, state.stats.recordsProcessed, state.stats.recordsFound);
            }

            // Process remaining buffer
            if (buffer) processLine(buffer);

            // Processing complete
            showResults();
        }

        // Parse XML line and extract record
        function processLine(line) {
            if (!line.includes('<Record')) return;

            state.stats.recordsProcessed++;

            // Extract attributes using regex
            const getAttr = (name) => {
                const match = line.match(new RegExp(`${name}="([^"]+)"`));
                return match ? match[1] : null;
            };

            const type = getAttr('type');
            const unit = getAttr('unit');
            const value = getAttr('value');
            const startDate = getAttr('startDate');
            const endDate = getAttr('endDate');
            const creationDate = getAttr('creationDate');

            // Clean type name
            const cleanType = type ? type.replace('HKQuantityTypeIdentifier', '').replace('HKCategoryTypeIdentifier', '') : '';

            // Filter: must be 2025 and (have a unit OR be SleepAnalysis)
            if (!startDate || !startDate.startsWith('2025') || (!unit && cleanType !== 'SleepAnalysis')) {
                return;
            }

            state.stats.recordsFound++;

            // Add to CSV data
            state.csvData.push({
                unit: unit || '',
                creationDate,
                value,
                startDate,
                type: cleanType,
                endDate
            });

            // Calculate statistics
            const numValue = parseFloat(value);

            switch (cleanType) {
                case 'StepCount':
                    if (!isNaN(numValue)) {
                        state.stats.totalSteps += numValue;
                        const day = startDate.split(' ')[0];
                        state.stats.stepsByDay[day] = (state.stats.stepsByDay[day] || 0) + numValue;
                    }
                    break;
                case 'DistanceWalkingRunning':
                    if (!isNaN(numValue)) {
                        state.stats.totalDistance += numValue;
                    }
                    break;
                case 'HeartRate':
                    if (!isNaN(numValue)) {
                        state.stats.heartRates.push(numValue);
                    }
                    break;
                case 'FlightsClimbed':
                    if (!isNaN(numValue)) {
                        state.stats.totalFlights += numValue;
                    }
                    break;
                case 'AppleStandTime':
                    if (!isNaN(numValue)) {
                        state.stats.totalStandTime += numValue;
                    }
                    break;
                case 'SleepAnalysis':
                    // Calculate duration from startDate to endDate (in minutes)
                    if (startDate && endDate) {
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        const durationMinutes = (end - start) / (1000 * 60);

                        // Only add if duration is valid (not NaN and positive)
                        if (!isNaN(durationMinutes) && durationMinutes > 0) {
                            if (value && value.includes('Asleep')) {
                                state.stats.sleepAsleep += durationMinutes;
                            }
                            state.stats.sleepInBed += durationMinutes;
                        }
                    }
                    break;
            }
        }

        // Update progress UI
        function updateProgress(percent, processed, found) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('recordsProcessed').textContent = processed.toLocaleString();
            document.getElementById('recordsFound').textContent = found.toLocaleString();
        }

        // Show results view
        function showResults() {
            document.getElementById('finalRecordCount').textContent = state.stats.recordsFound.toLocaleString();
            showView('resultsView');
        }

        // Generate and download CSV
        function downloadCSV() {
            const headers = ['unit', 'creationDate', 'value', 'startDate', 'type', 'endDate'];
            let csv = headers.join(',') + '\n';

            state.csvData.forEach(row => {
                csv += headers.map(h => row[h]).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `apple_health_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Calculate fitness age
        function calculateFitnessAge(age, gender, heartRates) {
            if (!age || heartRates.length === 0) return null;

            // Calculate max heart rate: HRmax = 208 - (0.7 √ó age)
            const hrMax = 208 - (0.7 * age);

            // Calculate resting heart rate (10th percentile)
            const sortedHR = heartRates.slice().sort((a, b) => a - b);
            const hrRest = sortedHR[Math.floor(sortedHR.length * 0.1)];

            // Calculate VO2 max: VO2max ‚âà (HRmax √∑ HRrest) √ó 15.3
            const vo2Max = (hrMax / hrRest) * 15.3;

            // Average VO2 max by age and gender
            const vo2MaxAverages = {
                male: {
                    20: 47, 30: 43, 40: 39, 50: 35, 60: 32, 70: 30
                },
                female: {
                    20: 41, 30: 38, 40: 35, 50: 31, 60: 28, 70: 26
                }
            };

            // Get average VO2 max for age group
            const ageGroup = Math.floor(age / 10) * 10;
            const avgVO2 = vo2MaxAverages[gender][ageGroup] ||
                          (gender === 'male' ? 35 : 31);

            // Calculate fitness age: Fitness Age = Age - 0.2 √ó (VO2max - Average VO2max)
            const fitnessAge = Math.round(age - 0.2 * (vo2Max - avgVO2));

            return {
                fitnessAge: fitnessAge,
                vo2Max: vo2Max.toFixed(1),
                difference: age - fitnessAge
            };
        }

        // Show wrapped view with stats
        function showWrapped() {
            const stats = state.stats;

            // Get user age and gender
            const ageInput = document.getElementById('userAge').value;
            const genderInput = document.getElementById('userGender').value;
            state.userAge = ageInput ? parseInt(ageInput) : null;
            state.userGender = genderInput;

            // Calculate derived stats
            const totalStepsM = (stats.totalSteps / 1000000).toFixed(2);
            const totalMiles = Math.round(stats.totalDistance);
            const totalKm = Math.round(stats.totalDistance * 1.60934);
            const dailySteps = Object.values(stats.stepsByDay);
            const avgDailySteps = dailySteps.length > 0 ? Math.round(dailySteps.reduce((a, b) => a + b, 0) / dailySteps.length) : 0;

            // Find the best day (date and steps)
            let maxDailySteps = 0;
            let bestDayDate = null;
            Object.entries(stats.stepsByDay).forEach(([date, steps]) => {
                if (steps > maxDailySteps) {
                    maxDailySteps = steps;
                    bestDayDate = date;
                }
            });

            // Format best day date as "DD/Month"
            let formattedBestDay = '-';
            if (bestDayDate) {
                const d = new Date(bestDayDate);
                const day = d.getDate();
                const month = d.toLocaleString('default', { month: 'long' });
                formattedBestDay = `${day}/${month}`;
            }

            const flightsClimbed = Math.round(stats.totalFlights);
            const standingDays = (stats.totalStandTime / 1440).toFixed(1); // Convert minutes to days
            const sleepDays = stats.sleepAsleep > 0 ? (stats.sleepAsleep / 1440).toFixed(1) : '0.0'; // Convert minutes to days

            // Calculate Burj Khalifa comparison (163 flights from bottom to top)
            const burjKhalifaTrips = (flightsClimbed / 163).toFixed(1);
            const burjComparison = burjKhalifaTrips >= 1
                ? `That's climbing the Burj Khalifa ${burjKhalifaTrips}x!`
                : `${Math.round(burjKhalifaTrips * 100)}% of the Burj Khalifa`;

            // Calculate moon comparison (moon circumference = 10,900 km)
            const moonPercentage = ((totalKm / 10900) * 100).toFixed(1);
            const moonComparison = moonPercentage >= 100
                ? `That's ${(moonPercentage / 100).toFixed(1)}x around the moon!`
                : `${moonPercentage}% of the way around the moon`;

            // Calculate fitness age if age provided
            let fitnessAgeData = null;
            if (state.userAge && stats.heartRates.length > 0) {
                fitnessAgeData = calculateFitnessAge(state.userAge, state.userGender, stats.heartRates);
            }

            // Update wrapped view
            document.getElementById('wrappedSteps').textContent = totalStepsM + 'M';
            document.getElementById('wrappedMiles').textContent = totalMiles.toLocaleString();
            document.getElementById('wrappedKm').textContent = totalKm.toLocaleString() + ' km';
            document.getElementById('moonComparison').textContent = moonComparison;
            document.getElementById('wrappedAvgSteps').textContent = avgDailySteps.toLocaleString();
            document.getElementById('wrappedStepsMessage').textContent = avgDailySteps > 10000 ? 'Above recommended 10K!' : 'Keep it up!';
            document.getElementById('wrappedBestDayDate').textContent = formattedBestDay;
            document.getElementById('wrappedBestDaySteps').textContent = `${Math.round(maxDailySteps).toLocaleString()} Steps`;
            document.getElementById('wrappedFlights').textContent = flightsClimbed.toLocaleString();
            document.getElementById('burjKhalifaComparison').textContent = burjComparison;
            document.getElementById('wrappedStanding').textContent = standingDays;
            document.getElementById('wrappedAsleep').textContent = sleepDays;

            // Show/hide fitness age card
            if (fitnessAgeData) {
                document.getElementById('fitnessAgeCard').style.display = 'flex';
                document.getElementById('wrappedFitnessAge').textContent = fitnessAgeData.fitnessAge;

                const diff = fitnessAgeData.difference;
                let message = '';
                if (diff > 0) {
                    message = `${diff} years younger!`;
                } else if (diff < 0) {
                    message = `${Math.abs(diff)} years older`;
                } else {
                    message = 'Right on target!';
                }
                document.getElementById('fitnessAgeMessage').textContent = message;
            } else {
                document.getElementById('fitnessAgeCard').style.display = 'none';
            }

            // Prepare and render charts
            prepareChartsData();
            renderCharts();

            showView('wrappedView');
        }

        // Prepare data for charts
        function prepareChartsData() {
            const stats = state.stats;

            // Process data by month
            state.chartData = {
                dailySteps: {},
                monthlySteps: {},
                monthlyDistance: {},
                weekdaySteps: {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0},
                weekdayCounts: {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0}
            };

            // Process steps by day and aggregate
            Object.entries(stats.stepsByDay).forEach(([date, steps]) => {
                const d = new Date(date);
                const month = d.toLocaleString('default', { month: 'short' });
                const weekday = d.getDay();

                state.chartData.dailySteps[date] = steps;
                state.chartData.monthlySteps[month] = (state.chartData.monthlySteps[month] || 0) + steps;
                state.chartData.weekdaySteps[weekday] += steps;
                state.chartData.weekdayCounts[weekday]++;
            });

            // Process distance by month
            state.csvData.filter(r => r.type === 'DistanceWalkingRunning').forEach(record => {
                const d = new Date(record.startDate);
                const month = d.toLocaleString('default', { month: 'short' });
                state.chartData.monthlyDistance[month] = (state.chartData.monthlyDistance[month] || 0) + parseFloat(record.value);
            });
        }

        // Render all charts
        function renderCharts() {
            // Configure Chart.js defaults for dark theme
            Chart.defaults.color = 'rgba(255, 255, 255, 0.8)';
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

            renderStepsChart();
            renderMonthlyChart();
            renderWeekdayChart();
        }

        // Daily Steps Line Chart
        function renderStepsChart() {
            const ctx = document.getElementById('stepsChart').getContext('2d');
            const dailySteps = state.chartData.dailySteps;
            const sortedDates = Object.keys(dailySteps).sort();

            // Sample data (show every 7th day to avoid clutter)
            const sampledDates = sortedDates.filter((_, i) => i % 7 === 0);
            const sampledSteps = sampledDates.map(d => dailySteps[d]);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sampledDates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Steps',
                        data: sampledSteps,
                        borderColor: '#00f5a0',
                        backgroundColor: 'rgba(0, 245, 160, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => value.toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        // Monthly Bar Chart
        function renderMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlySteps = months.map(m => state.chartData.monthlySteps[m] || 0);
            const monthlyDistance = months.map(m => Math.round((state.chartData.monthlyDistance[m] || 0) * 1.60934)); // Convert to km

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Steps',
                        data: monthlySteps,
                        backgroundColor: 'rgba(0, 245, 160, 0.6)',
                        borderColor: '#00f5a0',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Distance (km)',
                        data: monthlyDistance,
                        backgroundColor: 'rgba(0, 217, 245, 0.6)',
                        borderColor: '#00d9f5',
                        borderWidth: 2,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: {
                                callback: value => (value / 1000).toFixed(0) + 'K'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Weekday Radar Chart
        function renderWeekdayChart() {
            const ctx = document.getElementById('weekdayChart').getContext('2d');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const avgSteps = days.map((_, i) => {
                const count = state.chartData.weekdayCounts[i];
                return count > 0 ? Math.round(state.chartData.weekdaySteps[i] / count) : 0;
            });

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Avg Steps',
                        data: avgSteps,
                        borderColor: '#ffd93d',
                        backgroundColor: 'rgba(255, 217, 61, 0.2)',
                        pointBackgroundColor: '#ffd93d',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#ffd93d'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => (value / 1000).toFixed(0) + 'K'
                            }
                        }
                    }
                }
            });
        }

        // Event listeners
        document.getElementById('downloadCsvBtn').addEventListener('click', downloadCSV);
        document.getElementById('downloadCsvBtn2').addEventListener('click', downloadCSV);
        document.getElementById('showWrappedBtn').addEventListener('click', showWrapped);
        document.getElementById('backBtn').addEventListener('click', () => showView('resultsView'));
    </script>
</body>
</html>
